NewsRAG — Engineering Log & Technical Summary (Expanded & Corrected)
Date: 2025-12-05
Maintainer: Debrit Bhattacharyya

============================================================
1. OVERVIEW
============================================================
NewsRAG is a serverless ETL + RAG news intelligence system that ingests,
classifies, embeds, deduplicates, highlights, and surfaces news articles
through a dashboard and chatbot.

Stack:
- AWS Step Functions
- AWS Lambda
- Amazon Bedrock (Titan Embeddings, Claude 3 Sonnet/Haiku)
- MongoDB Atlas + Vector Search
- Streamlit Dashboard
- CloudFormation (SAM)
- GitHub CI/CD

============================================================
2. TRIGGER MECHANISM (CORRECTED)
============================================================
NewsRAG does **not** use EventBridge scheduling.

Instead, the ETL pipeline is triggered exclusively by:

1. **A Step Function execution defined inside template.yaml (SAM)**  
   The Step Function is deployed via SAM/CloudFormation and is invoked
   manually or programmatically.

2. **CI/CD automatic triggering after each deployment**  
   After GitHub Actions completes a deployment, it immediately triggers:
   - NewsRAG-ETL-Workflow
   This ensures the system processes fresh data after every code update.

There is **no automated scheduled EventBridge rule** in this architecture.

============================================================
3. DEVELOPMENT TIMELINE
============================================================

------------------------------------------------------------
A. 2025-11-29 — 2025-11-30
------------------------------------------------------------
Full ETL pipeline created with four Lambdas:
1. lambda_function.py — Scrape + classify
2. embedding_lambda.py — Generate embeddings
3. index_manager_lambda.py — Manage vector index
4. deduplicator_lambda.py — Deduplicate + highlight

Local testing harness added, including RSS scrapers, SMH extractor,
log checker, DB cleaner, and end-to-end ETL test drivers.

Added structured logging, timings, and debugging metadata.

------------------------------------------------------------
B. 2025-12-01 — 2025-12-04
------------------------------------------------------------
Index Manager debugging:
- Fixed dictionary-style access on model classes.
- Added required 'mappings' to vector index config.
- Added strict validation and error messages.

Scraper Lambda:
- Confidence thresholds filtered many articles; tuning planned.

------------------------------------------------------------
C. Chatbot Lambda + API Gateway
------------------------------------------------------------
- Added chatbot_lambda.py to handle query embedding + vector search +
  Claude 3 Sonnet generation.
- Integrated Titan Embeddings V2.
- Multiple deployment fixes to ensure chatbot file included in build.
- Debugged AccessDeniedException by subscribing to Claude model.

API Gateway Evolution:
- Initially added to CloudFormation.
- Later removed due to SAM proxy integration conflicts.
- Manually created API Gateway with POST /chat route.
- Fixed Missing Authentication Token errors.
- Enabled Lambda Proxy Integration to fix parsing issues.

------------------------------------------------------------
D. Streamlit Dashboard Enhancements
------------------------------------------------------------
- Added Chat tab with streamed responses.
- Added detailed error logging.
- Configured AWS_API_URL through secrets.
- Corrected chat response parsing to match Claude output.

============================================================
4. NEW FEATURES (2025-12-05)
============================================================

------------------------------------------------------------
A. Full HTML Extraction Module
------------------------------------------------------------
Created scrapers/html_extractor.py with:
- extract_full_content_from_url
- placeholder detection
- HTML cleanup + sanitization
- strict alphanumeric sanitizer for local tests

------------------------------------------------------------
B. Sanitization Framework
------------------------------------------------------------
Two sanitizers:
1. Standard production sanitization
2. Aggressive alnum-only sanitizer for local testing

Environment flags control:
- TRY_FULL_EXTRACTION_IN_PRODUCTION
- EXTRACTION_CONTENT_THRESHOLD
- USE_STRICT_SANITIZER_IN_PRODUCTION

------------------------------------------------------------
C. Local RSS Extraction Harness
------------------------------------------------------------
Supports:
- --full mode for HTML extraction testing
- Output metadata: extraction_strategy, _original_len, _extracted_len

------------------------------------------------------------
D. Production Integration
------------------------------------------------------------
_post_process_article now:
- Attempts HTML extraction when thresholds met
- Tracks metadata for diagnostics
- Applies appropriate sanitization mode

------------------------------------------------------------
E. Packaging Fixes
------------------------------------------------------------
- Exported missing scrapers.
- Added html_extractor to lambda_package.
- Fixed JSON serialization for published_date fields.
- Improved deduplication date comparison and highlight logic.
- Recommended DB-side TTL for deleting articles older than 24 hours.

============================================================
5. CHATBOT INTEGRATION IMPROVEMENTS (FROM CI/CD HISTORY)
============================================================

------------------------------------------------------------
A. Packaging & Dependency Fixes
------------------------------------------------------------
Several deployments revealed:
- chatbot_lambda.py was omitted from build → fixed packaging rules.
- streamlit added to requirements.txt for deployment consistency.

------------------------------------------------------------
B. AWS API Routing & Proxy Fixes
------------------------------------------------------------
- POST method not linked to Lambda → fixed integration.
- Enabled Lambda Proxy Integration for proper JSON structure.
- Updated dashboard to use AWS_API_URL from secrets.

------------------------------------------------------------
C. Response Handling & Error Logging
------------------------------------------------------------
- Improved debug logs for empty/malformed chatbot responses.
- Adjusted parsing logic for Claude message formats.

============================================================
6. DATA PIPELINE FIXES (FROM CI/CD HISTORY)
============================================================

------------------------------------------------------------
A. Date Handling Corrections
------------------------------------------------------------
Multiple commits fixed:
- Ensuring published_date stored as datetime.
- Correcting deletion query to use published_date.
- Fixing highlight logic to handle date comparisons correctly.
- Implementing robust cleanup logic for old articles.

------------------------------------------------------------
B. Step Function Invocation & Template Fixes
------------------------------------------------------------
- Corrected IAM policy formatting.
- Fixed Step Function → Lambda permission errors.
- Corrected MemorySize typo in template.yaml.
- Rolled back faulty deployments as needed.

============================================================
7. AUTOMATIC ARTICLE HIGHLIGHTING
============================================================
Added boolean “highlight” field. Scoring:
- 60% keyword weight
- 40% occurrence_count weight (normalized)
Top 5 per category marked highlight=true.

============================================================
8. CI/CD PIPELINE EVOLUTION
============================================================
- Automatic Step Function trigger after deployment.
- 31 workflow runs validating CI/CD stability.
- Repo cleanup: README updates, App Guide, .gitignore improvements.

============================================================
9. DASHBOARD UI ENHANCEMENTS
============================================================
- Removed date selectors; always shows latest highlights.
- Added bar + pie charts for highlight distribution.
- Display author with fallback "NA".

============================================================
10. PERFORMANCE NOTES
============================================================
Scraping currently sequential → causes Lambda timeout risk.
Planned: multithreaded scraping for major speed boost.

============================================================
11. ARCHITECTURE SUMMARY (CORRECTED)
============================================================
Trigger:  
- **Manual or CI/CD-triggered Step Function execution**  
- No EventBridge used.

Pipeline:
1. Scrape & classify
2. Embed
3. Index maintenance
4. Dedup & highlight

Outputs:
- MongoDB Atlas storage + Vector Search  
- Streamlit Dashboard  
- Chatbot API  
